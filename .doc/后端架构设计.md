# Spec2Test 后端架构设计

**版本**: v1.0  
**创建日期**: 2025-08-14  
**负责人**: Sean (deepractice.ai)  
**文档状态**: 设计中

---

## 1. 整体架构设计

### 1.1 架构原则
- **模块化设计**: 按PRD中的4个核心模块划分
- **松耦合**: 模块间通过接口通信，便于独立开发和测试
- **可扩展**: 支持后续添加新的LLM提供商和测试类型
- **容器化**: 支持Docker部署，便于环境一致性

### 1.2 技术栈选择
```
FastAPI (Web框架) + Python 3.12+
├── Pydantic (数据验证)
├── SQLAlchemy (ORM)
├── Alembic (数据库迁移)
├── Celery + Redis (异步任务)
├── pytest (测试框架)
└── Docker (容器化)
```

### 1.3 核心模块映射
```
PRD模块                    →  后端模块
文档分析与质量检查          →  document_analyzer
测试用例智能生成           →  test_generator  
测试执行引擎              →  test_executor
结果分析与报告            →  report_analyzer
```

---

## 2. 项目目录结构

```
spec2test-backend/
├── app/                          # 应用主目录
│   ├── __init__.py
│   ├── main.py                   # FastAPI应用入口
│   ├── config.py                 # 配置管理
│   ├── dependencies.py           # 依赖注入
│   │
│   ├── api/                      # API路由层
│   │   ├── __init__.py
│   │   ├── v1/                   # API版本管理
│   │   │   ├── __init__.py
│   │   │   ├── endpoints/        # 具体端点
│   │   │   │   ├── documents.py  # 文档相关API
│   │   │   │   ├── analysis.py   # 分析相关API
│   │   │   │   ├── tests.py      # 测试相关API
│   │   │   │   └── reports.py    # 报告相关API
│   │   │   └── api.py            # 路由汇总
│   │   └── middleware.py         # 中间件
│   │
│   ├── core/                     # 核心业务逻辑
│   │   ├── __init__.py
│   │   ├── document_analyzer/    # 模块1: 文档分析
│   │   │   ├── __init__.py
│   │   │   ├── parser.py         # 文档解析器
│   │   │   ├── validator.py      # 质量检查器
│   │   │   ├── chunker.py        # 文档分块器
│   │   │   └── models.py         # 数据模型
│   │   │
│   │   ├── test_generator/       # 模块2: 测试生成
│   │   │   ├── __init__.py
│   │   │   ├── llm_client.py     # LLM客户端
│   │   │   ├── prompt_builder.py # 提示词构建
│   │   │   ├── case_generator.py # 用例生成器
│   │   │   └── models.py         # 数据模型
│   │   │
│   │   ├── test_executor/        # 模块3: 测试执行
│   │   │   ├── __init__.py
│   │   │   ├── runner.py         # 测试运行器
│   │   │   ├── http_client.py    # HTTP客户端
│   │   │   ├── scheduler.py      # 任务调度器
│   │   │   └── models.py         # 数据模型
│   │   │
│   │   ├── report_analyzer/      # 模块4: 结果分析
│   │   │   ├── __init__.py
│   │   │   ├── analyzer.py       # 结果分析器
│   │   │   ├── reporter.py       # 报告生成器
│   │   │   ├── visualizer.py     # 可视化组件
│   │   │   └── models.py         # 数据模型
│   │   │
│   │   └── shared/               # 共享组件
│   │       ├── __init__.py
│   │       ├── llm/              # LLM抽象层
│   │       │   ├── __init__.py
│   │       │   ├── base.py       # 基础接口
│   │       │   ├── gemini.py     # Gemini实现
│   │       │   ├── ollama.py     # Ollama实现
│   │       │   └── factory.py    # 工厂模式
│   │       ├── storage/          # 存储抽象层
│   │       │   ├── __init__.py
│   │       │   ├── file_storage.py
│   │       │   └── db_storage.py
│   │       └── utils/            # 工具函数
│   │           ├── __init__.py
│   │           ├── logger.py
│   │           ├── exceptions.py
│   │           └── helpers.py
│   │
│   ├── models/                   # 数据库模型
│   │   ├── __init__.py
│   │   ├── base.py               # 基础模型
│   │   ├── document.py           # 文档模型
│   │   ├── test_case.py          # 测试用例模型
│   │   ├── test_result.py        # 测试结果模型
│   │   └── report.py             # 报告模型
│   │
│   ├── schemas/                  # Pydantic模式
│   │   ├── __init__.py
│   │   ├── document.py           # 文档相关模式
│   │   ├── test_case.py          # 测试用例模式
│   │   ├── test_result.py        # 测试结果模式
│   │   └── report.py             # 报告模式
│   │
│   └── tasks/                    # 异步任务
│       ├── __init__.py
│       ├── celery_app.py         # Celery配置
│       ├── document_tasks.py     # 文档处理任务
│       ├── test_tasks.py         # 测试执行任务
│       └── report_tasks.py       # 报告生成任务
│
├── tests/                        # 测试目录
│   ├── __init__.py
│   ├── conftest.py               # pytest配置
│   ├── unit/                     # 单元测试
│   │   ├── test_document_analyzer/
│   │   ├── test_test_generator/
│   │   ├── test_test_executor/
│   │   └── test_report_analyzer/
│   ├── integration/              # 集成测试
│   │   ├── test_api/
│   │   └── test_workflows/
│   └── fixtures/                 # 测试数据
│       ├── sample_openapi.json
│       ├── sample_markdown.md
│       └── expected_results/
│
├── migrations/                   # 数据库迁移
│   └── versions/
│
├── docker/                       # Docker相关
│   ├── Dockerfile
│   ├── docker-compose.yml
│   ├── docker-compose.dev.yml
│   └── requirements/
│       ├── base.txt
│       ├── dev.txt
│       └── prod.txt
│
├── scripts/                      # 脚本工具
│   ├── init_db.py               # 数据库初始化
│   ├── run_tests.py             # 测试运行
│   └── deploy.py                # 部署脚本
│
├── docs/                        # 开发文档
│   ├── api.md                   # API文档
│   ├── deployment.md            # 部署文档
│   └── development.md           # 开发指南
│
├── .env.example                 # 环境变量示例
├── .gitignore
├── README.md
├── requirements.txt
└── pyproject.toml              # 项目配置
```

---

## 3. 核心模块设计

### 3.1 文档分析模块 (document_analyzer)

**职责**: 解析、验证和分块处理用户上传的文档

**核心组件**:
```python
# parser.py - 文档解析器
class DocumentParser:
    def detect_format(self, content: str) -> DocumentType
    def parse_openapi(self, content: str) -> ParsedDocument
    def parse_markdown(self, content: str) -> ParsedDocument
    
# validator.py - 质量检查器  
class DocumentValidator:
    def validate_completeness(self, doc: ParsedDocument) -> QualityReport
    def check_consistency(self, doc: ParsedDocument) -> List[Issue]
    def suggest_improvements(self, issues: List[Issue]) -> List[Suggestion]

# chunker.py - 文档分块器
class DocumentChunker:
    def chunk_by_endpoints(self, doc: ParsedDocument) -> List[DocumentChunk]
    def estimate_tokens(self, chunk: DocumentChunk) -> int
    def optimize_chunks(self, chunks: List[DocumentChunk]) -> List[DocumentChunk]
```

### 3.2 测试生成模块 (test_generator)

**职责**: 基于文档分析结果，调用LLM生成结构化测试用例

**核心组件**:
```python
# llm_client.py - LLM客户端
class LLMClient:
    def generate_test_cases(self, prompt: str, schema: dict) -> TestCaseSet
    def analyze_document_quality(self, doc_chunk: DocumentChunk) -> QualityAnalysis
    
# case_generator.py - 用例生成器
class TestCaseGenerator:
    def generate_for_endpoint(self, endpoint: APIEndpoint) -> List[TestCase]
    def generate_edge_cases(self, endpoint: APIEndpoint) -> List[TestCase]
    def generate_error_cases(self, endpoint: APIEndpoint) -> List[TestCase]
```

### 3.3 测试执行模块 (test_executor)

**职责**: 将测试用例转换为可执行代码并运行

**核心组件**:
```python
# runner.py - 测试运行器
class TestRunner:
    def execute_test_suite(self, test_suite: TestSuite) -> TestResults
    def execute_single_test(self, test_case: TestCase) -> TestResult
    def handle_concurrent_execution(self, test_cases: List[TestCase]) -> TestResults

# http_client.py - HTTP客户端
class HTTPClient:
    def make_request(self, test_case: TestCase) -> HTTPResponse
    def handle_authentication(self, auth_config: AuthConfig) -> None
    def validate_response(self, response: HTTPResponse, expected: ExpectedResponse) -> ValidationResult
```

### 3.4 结果分析模块 (report_analyzer)

**职责**: 分析测试结果，生成智能报告

**核心组件**:
```python
# analyzer.py - 结果分析器
class ResultAnalyzer:
    def analyze_failures(self, results: TestResults) -> FailureAnalysis
    def identify_patterns(self, results: TestResults) -> List[Pattern]
    def suggest_fixes(self, failures: List[TestFailure]) -> List[Suggestion]

# reporter.py - 报告生成器  
class ReportGenerator:
    def generate_summary_report(self, results: TestResults) -> SummaryReport
    def generate_detailed_report(self, results: TestResults) -> DetailedReport
    def export_to_format(self, report: Report, format: str) -> bytes
```

---

## 4. 数据流设计

### 4.1 核心数据流
```
1. 文档上传 → DocumentParser → ParsedDocument
2. ParsedDocument → DocumentValidator → QualityReport  
3. ParsedDocument → DocumentChunker → List[DocumentChunk]
4. DocumentChunk → TestCaseGenerator → TestCaseSet
5. TestCaseSet → TestRunner → TestResults
6. TestResults → ResultAnalyzer → AnalysisReport
7. AnalysisReport → ReportGenerator → FinalReport
```

### 4.2 异步任务设计
```python
# 长时间运行的任务使用Celery异步处理
@celery_app.task
def analyze_document_task(document_id: str) -> str:
    """异步分析文档任务"""
    
@celery_app.task  
def generate_tests_task(document_id: str, chunks: List[dict]) -> str:
    """异步生成测试用例任务"""
    
@celery_app.task
def execute_tests_task(test_suite_id: str) -> str:
    """异步执行测试任务"""
```

---

## 5. API设计概览

### 5.1 RESTful API结构
```
POST   /api/v1/documents/           # 上传文档
GET    /api/v1/documents/{id}       # 获取文档信息
POST   /api/v1/documents/{id}/analyze  # 分析文档质量

POST   /api/v1/tests/generate       # 生成测试用例
GET    /api/v1/tests/{id}           # 获取测试用例
POST   /api/v1/tests/{id}/execute   # 执行测试

GET    /api/v1/reports/{id}         # 获取测试报告
POST   /api/v1/reports/{id}/export  # 导出报告

GET    /api/v1/tasks/{task_id}      # 查询异步任务状态
```

### 5.2 WebSocket支持
```
/ws/tasks/{task_id}                 # 实时任务进度推送
/ws/test-execution/{test_id}        # 实时测试执行状态
```

---

## 6. 配置管理

### 6.1 环境配置
```python
# config.py
class Settings(BaseSettings):
    # 基础配置
    app_name: str = "Spec2Test"
    debug: bool = False
    
    # 数据库配置
    database_url: str
    
    # LLM配置
    gemini_api_key: Optional[str] = None
    ollama_base_url: str = "http://localhost:11434"
    
    # Redis配置 (Celery)
    redis_url: str = "redis://localhost:6379"
    
    # 文件存储
    upload_dir: str = "./uploads"
    max_file_size: int = 10 * 1024 * 1024  # 10MB
    
    class Config:
        env_file = ".env"
```

---

## 7. 部署架构

### 7.1 Docker Compose结构
```yaml
# docker-compose.yml
services:
  api:
    build: .
    ports: ["8000:8000"]
    depends_on: [db, redis]
    
  worker:
    build: .
    command: celery worker
    depends_on: [db, redis]
    
  db:
    image: postgres:15
    
  redis:
    image: redis:7-alpine
    
  nginx:
    image: nginx:alpine
    ports: ["80:80"]
```

---

## 8. 开发计划

### 8.1 开发优先级
1. **Week 1**: 项目基础架构 + 文档分析模块
2. **Week 2**: 测试生成模块 + LLM集成
3. **Week 3**: 测试执行模块 + HTTP客户端
4. **Week 4**: 结果分析模块 + 报告生成
5. **Week 5**: API层 + 异步任务集成
6. **Week 6**: 测试 + 优化 + 部署

### 8.2 关键里程碑
- **里程碑1**: 单个OpenAPI文档的完整流水线
- **里程碑2**: 支持多种文档格式和LLM
- **里程碑3**: 并发执行和实时反馈
- **里程碑4**: 生产就绪的部署方案

---

**文档状态**: 设计完成  
**下一步行动**: 开始核心模块开发
