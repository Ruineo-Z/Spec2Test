# æ•°æ®åº“é…ç½®æŒ‡å—

**ç‰ˆæœ¬**: v1.0.0  
**æ›´æ–°æ—¶é—´**: 2025-01-15  
**é€‚ç”¨ç‰ˆæœ¬**: PostgreSQL 16, SQLite 3.x  

## ğŸ¯ æ•°æ®åº“é€‰æ‹©ç­–ç•¥

### æ¨èé…ç½®
```bash
# ç”Ÿäº§ç¯å¢ƒ: PostgreSQL 16
DATABASE_URL="postgresql://spec2test_user:secure_password@localhost:5432/spec2test"

# å¼€å‘ç¯å¢ƒ: PostgreSQL 16 (æ¨è) æˆ– SQLite (å¯é€‰)
DATABASE_URL="postgresql://spec2test_user:dev_password@localhost:5432/spec2test_dev"
# DATABASE_URL="sqlite:///./spec2test_dev.db"

# æµ‹è¯•ç¯å¢ƒ: SQLite (å¿«é€Ÿé‡ç½®)
TEST_DATABASE_URL="sqlite:///./test_spec2test.db"
```

## ğŸ˜ PostgreSQL 16 é…ç½®

### 1. å®‰è£…PostgreSQL 16

#### Ubuntu/Debian
```bash
# æ·»åŠ PostgreSQLå®˜æ–¹ä»“åº“
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt update

# å®‰è£…PostgreSQL 16
sudo apt install -y postgresql-16 postgresql-contrib-16 postgresql-client-16
```

#### CentOS/RHEL
```bash
# å®‰è£…PostgreSQL 16ä»“åº“
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# å®‰è£…PostgreSQL 16
sudo yum install -y postgresql16-server postgresql16-contrib
sudo /usr/pgsql-16/bin/postgresql-16-setup initdb
sudo systemctl enable postgresql-16
sudo systemctl start postgresql-16
```

#### macOS
```bash
# ä½¿ç”¨Homebrew
brew install postgresql@16
brew services start postgresql@16
```

### 2. æ•°æ®åº“å’Œç”¨æˆ·åˆ›å»º

```bash
# åˆ‡æ¢åˆ°postgresç”¨æˆ·
sudo -u postgres psql

# åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
CREATE USER spec2test_user WITH PASSWORD 'your_secure_password';

# åˆ›å»ºç”Ÿäº§æ•°æ®åº“
CREATE DATABASE spec2test OWNER spec2test_user;

# åˆ›å»ºå¼€å‘æ•°æ®åº“
CREATE DATABASE spec2test_dev OWNER spec2test_user;

# åˆ›å»ºæµ‹è¯•æ•°æ®åº“
CREATE DATABASE spec2test_test OWNER spec2test_user;

# æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE spec2test TO spec2test_user;
GRANT ALL PRIVILEGES ON DATABASE spec2test_dev TO spec2test_user;
GRANT ALL PRIVILEGES ON DATABASE spec2test_test TO spec2test_user;

# é€€å‡º
\q
```

### 3. PostgreSQL 16 æ€§èƒ½é…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/postgresql/16/main/postgresql.conf
```

```ini
# è¿æ¥é…ç½®
listen_addresses = 'localhost'          # ç›‘å¬åœ°å€
port = 5432                             # ç«¯å£
max_connections = 100                   # æœ€å¤§è¿æ¥æ•°

# å†…å­˜é…ç½® (æ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´)
shared_buffers = 256MB                  # å…±äº«ç¼“å†²åŒº (25% of RAM)
effective_cache_size = 1GB              # æœ‰æ•ˆç¼“å­˜å¤§å° (75% of RAM)
work_mem = 4MB                          # å·¥ä½œå†…å­˜ (per connection)
maintenance_work_mem = 64MB             # ç»´æŠ¤å·¥ä½œå†…å­˜

# WALé…ç½®
wal_buffers = 16MB                      # WALç¼“å†²åŒº
checkpoint_completion_target = 0.9      # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
max_wal_size = 1GB                      # æœ€å¤§WALå¤§å°
min_wal_size = 80MB                     # æœ€å°WALå¤§å°

# æŸ¥è¯¢ä¼˜åŒ–
random_page_cost = 1.1                  # SSDä¼˜åŒ–
effective_io_concurrency = 200          # SSDå¹¶å‘IO

# æ—¥å¿—é…ç½®
logging_collector = on                  # å¯ç”¨æ—¥å¿—æ”¶é›†
log_directory = 'log'                   # æ—¥å¿—ç›®å½•
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_statement = 'mod'                   # è®°å½•ä¿®æ”¹è¯­å¥
log_min_duration_statement = 1000       # è®°å½•æ…¢æŸ¥è¯¢ (1ç§’+)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ç»Ÿè®¡ä¿¡æ¯
track_activities = on                   # è·Ÿè¸ªæ´»åŠ¨
track_counts = on                       # è·Ÿè¸ªè®¡æ•°
track_io_timing = on                    # è·Ÿè¸ªIOæ—¶é—´
```

```bash
# é‡å¯PostgreSQLåº”ç”¨é…ç½®
sudo systemctl restart postgresql-16
```

### 4. è¿æ¥æµ‹è¯•

```bash
# æµ‹è¯•è¿æ¥
psql -h localhost -U spec2test_user -d spec2test -c "SELECT version();"

# æµ‹è¯•Pythonè¿æ¥
python -c "
import asyncio
import asyncpg

async def test_connection():
    conn = await asyncpg.connect('postgresql://spec2test_user:password@localhost:5432/spec2test')
    version = await conn.fetchval('SELECT version()')
    print(f'Connected to: {version}')
    await conn.close()

asyncio.run(test_connection())
"
```

## ğŸ’¾ SQLite é…ç½® (å¼€å‘å¯é€‰)

### 1. SQLiteä¼˜åŠ¿
```bash
âœ… é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨
âœ… å•æ–‡ä»¶æ•°æ®åº“ï¼Œä¾¿äºå¤‡ä»½å’Œç§»åŠ¨
âœ… é€‚åˆå¿«é€Ÿå¼€å‘å’ŒåŸå‹éªŒè¯
âœ… æ— éœ€é¢å¤–æœåŠ¡è¿›ç¨‹
âœ… æ”¯æŒå¤§éƒ¨åˆ†SQLæ ‡å‡†
```

### 2. SQLiteé…ç½®
```python
# SQLiteè¿æ¥é…ç½®
DATABASE_URL = "sqlite:///./spec2test.db"

# SQLiteè¿æ¥å‚æ•°
SQLITE_CONFIG = {
    "echo": False,
    "connect_args": {
        "check_same_thread": False,  # å…è®¸å¤šçº¿ç¨‹
        "timeout": 20,               # è¿æ¥è¶…æ—¶
        "isolation_level": None      # è‡ªåŠ¨æäº¤æ¨¡å¼
    }
}
```

### 3. SQLiteæ€§èƒ½ä¼˜åŒ–
```sql
-- æ€§èƒ½ä¼˜åŒ–PRAGMAè®¾ç½®
PRAGMA journal_mode = WAL;          -- å¯ç”¨WALæ¨¡å¼
PRAGMA synchronous = NORMAL;        -- åŒæ­¥æ¨¡å¼
PRAGMA cache_size = 10000;          -- ç¼“å­˜å¤§å°
PRAGMA temp_store = memory;         -- ä¸´æ—¶å­˜å‚¨åœ¨å†…å­˜
PRAGMA mmap_size = 268435456;       -- å†…å­˜æ˜ å°„å¤§å° (256MB)
```

## ğŸ”„ æ•°æ®åº“åˆ‡æ¢æŒ‡å—

### 1. ä»SQLiteåˆ‡æ¢åˆ°PostgreSQL

```bash
# 1. å®‰è£…å’Œé…ç½®PostgreSQL
# (å‚è€ƒä¸Šé¢çš„PostgreSQLé…ç½®)

# 2. å¯¼å‡ºSQLiteæ•°æ®
sqlite3 spec2test.db .dump > spec2test_backup.sql

# 3. è½¬æ¢SQLè¯­æ³• (å¦‚éœ€è¦)
# SQLite -> PostgreSQLè¯­æ³•å·®å¼‚å¤„ç†

# 4. ä¿®æ”¹ç¯å¢ƒå˜é‡
vim .env
# DATABASE_URL="postgresql://spec2test_user:password@localhost:5432/spec2test"

# 5. è¿è¡Œè¿ç§»
alembic upgrade head

# 6. å¯¼å…¥æ•°æ® (å¦‚éœ€è¦)
psql -h localhost -U spec2test_user -d spec2test < converted_data.sql

# 7. é‡å¯åº”ç”¨
sudo systemctl restart spec2test
```

### 2. ä»PostgreSQLåˆ‡æ¢åˆ°SQLite

```bash
# 1. å¯¼å‡ºPostgreSQLæ•°æ®
pg_dump -h localhost -U spec2test_user -d spec2test > spec2test_backup.sql

# 2. ä¿®æ”¹ç¯å¢ƒå˜é‡
vim .env
# DATABASE_URL="sqlite:///./spec2test.db"

# 3. è¿è¡Œè¿ç§»
alembic upgrade head

# 4. è½¬æ¢å’Œå¯¼å…¥æ•°æ® (å¦‚éœ€è¦)
# PostgreSQL -> SQLiteè¯­æ³•è½¬æ¢

# 5. é‡å¯åº”ç”¨
sudo systemctl restart spec2test
```

## ğŸ”§ æ•°æ®åº“ç»´æŠ¤

### PostgreSQLç»´æŠ¤

```bash
# 1. æ•°æ®åº“å¤‡ä»½
pg_dump -h localhost -U spec2test_user -d spec2test > backup_$(date +%Y%m%d).sql
gzip backup_$(date +%Y%m%d).sql

# 2. æ•°æ®åº“æ¢å¤
psql -h localhost -U spec2test_user -d spec2test < backup_20250115.sql

# 3. æ•°æ®åº“ä¼˜åŒ–
psql -h localhost -U spec2test_user -d spec2test -c "VACUUM ANALYZE;"

# 4. æŸ¥çœ‹æ•°æ®åº“å¤§å°
psql -h localhost -U spec2test_user -d spec2test -c "
SELECT 
    pg_size_pretty(pg_database_size('spec2test')) as database_size,
    pg_size_pretty(pg_total_relation_size('tasks')) as tasks_table_size;
"

# 5. æŸ¥çœ‹è¿æ¥æ•°
psql -h localhost -U spec2test_user -d spec2test -c "
SELECT count(*) as active_connections 
FROM pg_stat_activity 
WHERE state = 'active';
"
```

### SQLiteç»´æŠ¤

```bash
# 1. æ•°æ®åº“å¤‡ä»½
cp spec2test.db spec2test_backup_$(date +%Y%m%d).db

# 2. æ•°æ®åº“ä¼˜åŒ–
sqlite3 spec2test.db "VACUUM;"
sqlite3 spec2test.db "ANALYZE;"

# 3. æŸ¥çœ‹æ•°æ®åº“å¤§å°
ls -lh spec2test.db

# 4. æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥
sqlite3 spec2test.db "PRAGMA integrity_check;"
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### PostgreSQL 16 vs SQLite

| ç‰¹æ€§ | PostgreSQL 16 | SQLite |
|------|---------------|---------|
| å¹¶å‘å†™å…¥ | âœ… ä¼˜ç§€ | âš ï¸ æœ‰é™ |
| å¹¶å‘è¯»å– | âœ… ä¼˜ç§€ | âœ… è‰¯å¥½ |
| æ•°æ®å®Œæ•´æ€§ | âœ… å®Œæ•´ACID | âœ… å®Œæ•´ACID |
| å¤æ‚æŸ¥è¯¢ | âœ… ä¼˜ç§€ | âœ… è‰¯å¥½ |
| æ•°æ®ç±»å‹ | âœ… ä¸°å¯Œ | âš ï¸ æœ‰é™ |
| æ‰©å±•æ€§ | âœ… ä¼˜ç§€ | âŒ æœ‰é™ |
| éƒ¨ç½²å¤æ‚åº¦ | âš ï¸ ä¸­ç­‰ | âœ… ç®€å• |
| èµ„æºæ¶ˆè€— | âš ï¸ è¾ƒé«˜ | âœ… å¾ˆä½ |
| ç”Ÿäº§å°±ç»ª | âœ… å®Œå…¨ | âš ï¸ å°è§„æ¨¡ |

### é€‰æ‹©å»ºè®®

```bash
# é€‰æ‹©PostgreSQLçš„åœºæ™¯:
âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
âœ… é«˜å¹¶å‘è®¿é—®éœ€æ±‚
âœ… å¤æ‚æŸ¥è¯¢å’Œåˆ†æ
âœ… æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜
âœ… éœ€è¦æ‰©å±•æ€§

# é€‰æ‹©SQLiteçš„åœºæ™¯:
âœ… å¿«é€Ÿå¼€å‘å’ŒåŸå‹
âœ… å•ç”¨æˆ·æˆ–ä½å¹¶å‘
âœ… ç®€å•çš„æ•°æ®æ“ä½œ
âœ… åµŒå…¥å¼åº”ç”¨
âœ… é›¶é…ç½®éœ€æ±‚
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### æ•°æ®ç±»å‹å·®å¼‚
```python
# PostgreSQLæ”¯æŒåŸç”ŸJSONç±»å‹
input_data = Column(postgresql.JSON)

# SQLiteå°†JSONå­˜å‚¨ä¸ºTEXT
input_data = Column(Text)  # éœ€è¦æ‰‹åŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
```

### å¹¶å‘é™åˆ¶
```python
# PostgreSQL: æ”¯æŒé«˜å¹¶å‘è¯»å†™
# SQLite: åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå†™æ“ä½œ

# åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒSQLiteå¯èƒ½å‡ºç°:
# sqlite3.OperationalError: database is locked
```

### è¿ç§»å…¼å®¹æ€§
```python
# ç¡®ä¿Alembicè¿ç§»è„šæœ¬å…¼å®¹ä¸¤ç§æ•°æ®åº“
def upgrade():
    bind = op.get_bind()
    if bind.dialect.name == 'postgresql':
        # PostgreSQLç‰¹å®šæ“ä½œ
        pass
    elif bind.dialect.name == 'sqlite':
        # SQLiteç‰¹å®šæ“ä½œ
        pass
```

---

**ç»´æŠ¤è¯´æ˜**: æœ¬æŒ‡å—éšæ•°æ®åº“ç‰ˆæœ¬æ›´æ–°è€Œæ›´æ–°  
**æŠ€æœ¯æ”¯æŒ**: é‡åˆ°é—®é¢˜è¯·å‚è€ƒæ•…éšœæ’é™¤æˆ–æäº¤Issue  
**æ¨èé…ç½®**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨PostgreSQL 16ï¼Œå¼€å‘ç¯å¢ƒå¯é€‰SQLite
