# Spec2Test 技术架构设计

**版本**: v1.0.0  
**更新时间**: 2025-01-15  
**状态**: 设计完成，实施中  

## 🎯 架构概述

Spec2Test采用**现代化单体架构**，基于FastAPI构建高性能API测试自动化平台。

### 核心设计原则
- **简洁优先**: 避免过度工程化，保持架构简洁
- **性能导向**: 基于异步I/O，支持高并发处理
- **渐进演进**: 支持从单体到微服务的平滑演进
- **文档驱动**: 完整的API文档和代码文档

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Spec2Test 系统架构                        │
├─────────────────────────────────────────────────────────────┤
│  API接口层 (FastAPI)                                        │
│  ├── 文档管理API    ├── 测试管理API                         │
│  ├── 报告管理API    └── 任务状态API                         │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                 │
│  ├── 文档分析器     ├── 测试生成器                         │
│  ├── 测试执行器     └── 结果分析器                         │
├─────────────────────────────────────────────────────────────┤
│  异步任务层 (Enhanced BackgroundTasks)                     │
│  ├── 任务管理器     ├── 重试机制                           │
│  ├── 状态跟踪       └── 性能监控                           │
├─────────────────────────────────────────────────────────────┤
│  共享服务层                                                 │
│  ├── 存储服务       ├── LLM服务                            │
│  ├── HTTP客户端     └── 日志服务                           │
├─────────────────────────────────────────────────────────────┤
│  数据存储层                                                 │
│  ├── PostgreSQL 16 (主要数据库，生产+开发)                │
│  ├── SQLite (开发环境可选，一键切换)                       │
│  ├── 文件系统 (文档和报告)                                 │
│  └── 内存缓存 (临时状态)                                   │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 核心组件设计

### 1. API接口层 (已完成)

#### FastAPI应用
```python
# 核心特性
- 异步处理: 基于asyncio的高性能处理
- 自动文档: OpenAPI 3.0规范自动生成
- 类型安全: Pydantic模型验证
- 中间件: 日志、异常、验证、限流
```

#### 端点设计
- **RESTful风格**: 标准的HTTP方法和状态码
- **统一响应**: 一致的JSON响应格式
- **错误处理**: 分层的异常处理机制
- **版本管理**: 支持API版本演进

### 2. 异步任务层 (设计更新)

#### 设计决策: 基于FastAPI BackgroundTasks
```python
# 选择理由:
✅ FastAPI原生支持，无额外依赖
✅ 异步处理，性能优秀
✅ 部署简单，维护容易
✅ 支持渐进式演进

# 避免Celery的原因:
❌ 增加Redis/RabbitMQ依赖
❌ 部署复杂度提升
❌ 当前规模不需要分布式
❌ 维护成本增加
```

#### 增强任务系统架构
```python
EnhancedTaskSystem:
  ├── TaskManager (任务管理器)
  │   ├── 任务创建和调度
  │   ├── 状态跟踪和更新
  │   └── 生命周期管理
  │
  ├── TaskStorage (任务存储)
  │   ├── SQLite/PostgreSQL持久化
  │   ├── 任务状态存储
  │   └── 执行历史记录
  │
  ├── RetryManager (重试管理)
  │   ├── 智能重试策略
  │   ├── 指数退避算法
  │   └── 错误分类处理
  │
  ├── ExecutorPool (执行器池)
  │   ├── ProcessPoolExecutor (CPU密集型)
  │   ├── ThreadPoolExecutor (I/O密集型)
  │   └── 资源管理和优化
  │
  └── TaskMonitor (任务监控)
      ├── 性能指标收集
      ├── 执行统计分析
      └── 实时状态展示
```

### 3. 业务逻辑层

#### 模块化设计
```python
# 核心业务模块
DocumentAnalyzer:     # 文档分析
  ├── 解析器 (Parser)
  ├── 验证器 (Validator)  
  ├── 分块器 (Chunker)
  └── 质量检查器

TestGenerator:        # 测试生成
  ├── 用例生成器
  ├── 数据生成器
  ├── 断言生成器
  └── 场景构建器

TestExecutor:         # 测试执行
  ├── HTTP客户端
  ├── 并发控制器
  ├── 结果收集器
  └── 性能监控器

ResultAnalyzer:       # 结果分析
  ├── 统计分析器
  ├── 失败分析器
  ├── 性能分析器
  └── 报告生成器
```

### 4. 共享服务层

#### 服务组件
```python
# 存储服务
StorageService:
  ├── FileStorage (文件存储)
  ├── DatabaseStorage (数据库存储)
  ├── CacheStorage (缓存存储)
  └── StorageFactory (存储工厂)

# LLM服务
LLMService:
  ├── OpenAI客户端
  ├── Gemini客户端
  ├── LangChain集成
  └── 模型工厂

# HTTP服务
HTTPService:
  ├── 异步HTTP客户端
  ├── 连接池管理
  ├── 重试机制
  └── 性能监控
```

## 🗄️ 数据库兼容性设计

### 多数据库支持策略

#### 设计原则
- **统一抽象**: 使用SQLAlchemy ORM提供数据库无关的抽象层
- **配置驱动**: 通过环境变量控制数据库选择
- **无缝切换**: 修改URL即可在不同数据库间切换
- **开发生产一致**: 推荐生产开发都使用PostgreSQL

#### 支持的数据库

```python
# PostgreSQL 16 (推荐)
DATABASE_URL = "postgresql://user:password@localhost:5432/spec2test"

优势:
✅ 最新PostgreSQL特性和性能优化
✅ 完整ACID事务支持
✅ 高并发处理能力
✅ 丰富的数据类型和索引
✅ 生产环境成熟稳定
✅ 支持复杂查询和分析

# SQLite (开发可选)
DATABASE_URL = "sqlite:///./spec2test.db"

优势:
✅ 零配置，开箱即用
✅ 单文件数据库
✅ 适合快速开发和测试
✅ 无需额外服务进程
```

#### 数据库抽象实现

```python
# 统一的数据库模型
class BaseModel:
    """数据库模型基类"""
    id = Column(String, primary_key=True, default=lambda: str(uuid.uuid4()))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

class TaskModel(BaseModel):
    """任务模型 - 数据库无关"""
    __tablename__ = "tasks"

    task_type = Column(String, nullable=False)
    status = Column(String, nullable=False)
    input_data = Column(JSON)  # PostgreSQL原生JSON，SQLite存储为TEXT
    result_data = Column(JSON)

# 数据库引擎工厂
def create_database_engine(database_url: str):
    """根据URL创建对应的数据库引擎"""
    if database_url.startswith("postgresql"):
        return create_async_engine(
            database_url,
            pool_size=20,
            max_overflow=30,
            pool_pre_ping=True,
            echo=False
        )
    elif database_url.startswith("sqlite"):
        return create_async_engine(
            database_url,
            echo=False,
            connect_args={"check_same_thread": False}
        )
    else:
        raise ValueError(f"Unsupported database URL: {database_url}")
```

#### 迁移兼容性

```python
# Alembic迁移脚本自动适配
def upgrade():
    """数据库升级脚本"""
    # 检测数据库类型
    bind = op.get_bind()
    if bind.dialect.name == 'postgresql':
        # PostgreSQL特定操作
        op.create_table('tasks',
            sa.Column('id', sa.String(), nullable=False),
            sa.Column('input_data', postgresql.JSON(), nullable=True),
            # ...
        )
    elif bind.dialect.name == 'sqlite':
        # SQLite特定操作
        op.create_table('tasks',
            sa.Column('id', sa.String(), nullable=False),
            sa.Column('input_data', sa.Text(), nullable=True),  # JSON as TEXT
            # ...
        )
```

#### 性能优化配置

```python
# PostgreSQL优化配置
POSTGRESQL_CONFIG = {
    "pool_size": 20,
    "max_overflow": 30,
    "pool_pre_ping": True,
    "pool_recycle": 3600,
    "echo": False
}

# SQLite优化配置
SQLITE_CONFIG = {
    "echo": False,
    "connect_args": {
        "check_same_thread": False,
        "timeout": 20
    }
}
```

## 📊 数据流设计

### 完整业务流程
```
1. 文档上传
   ├── API接收文件
   ├── 文件验证和存储
   ├── 创建文档记录
   └── 返回文档ID

2. 文档分析 (异步任务)
   ├── 任务创建和持久化
   ├── 后台异步执行
   ├── 状态实时更新
   └── 结果存储

3. 测试生成 (异步任务)
   ├── 基于分析结果
   ├── LLM辅助生成
   ├── 测试用例优化
   └── 测试套件创建

4. 测试执行 (异步任务)
   ├── 并发HTTP请求
   ├── 实时结果收集
   ├── 性能数据记录
   └── 执行报告生成

5. 结果分析 (异步任务)
   ├── 统计数据分析
   ├── 失败原因分析
   ├── 性能趋势分析
   └── 多格式报告生成
```

### 任务状态流转
```
任务生命周期:
PENDING → RUNNING → COMPLETED
    ↓         ↓         ↑
  FAILED ← RETRYING ←──┘
    ↓
  CANCELLED
```

## 🔄 异步处理设计

### 任务类型分类
```python
# CPU密集型任务 (使用进程池)
- 文档解析和验证
- 测试用例生成
- 数据分析和统计
- 报告生成

# I/O密集型任务 (使用线程池)
- HTTP请求执行
- 文件读写操作
- 数据库查询
- LLM API调用
```

### 性能优化策略
```python
# 并发控制
- 进程池: max_workers = CPU核心数
- 线程池: max_workers = CPU核心数 * 4
- 连接池: 复用HTTP连接
- 内存池: 对象复用机制

# 资源管理
- 任务超时控制
- 内存使用监控
- 连接数限制
- 优雅关闭机制
```

## 🛡️ 安全和可靠性

### 错误处理策略
```python
# 异常分层
BusinessException:    # 业务逻辑异常
  ├── 参数验证错误
  ├── 业务规则违反
  └── 状态不一致

SystemException:      # 系统级异常
  ├── 数据库连接失败
  ├── 文件系统错误
  └── 网络通信异常

ValidationException:  # 数据验证异常
  ├── 请求格式错误
  ├── 参数类型错误
  └── 约束条件违反
```

### 重试机制
```python
# 智能重试策略
RetryStrategy:
  ├── 指数退避: 1s, 2s, 4s, 8s, 16s
  ├── 最大重试: 5次
  ├── 错误分类: 可重试 vs 不可重试
  └── 熔断机制: 连续失败后停止
```

## 📈 监控和观测

### 指标收集
```python
# 任务指标
TaskMetrics:
  ├── 执行时间分布
  ├── 成功/失败率
  ├── 重试次数统计
  └── 并发度监控

# 系统指标
SystemMetrics:
  ├── CPU和内存使用
  ├── 数据库连接数
  ├── HTTP请求延迟
  └── 错误率统计
```

### 日志设计
```python
# 结构化日志
LogStructure:
  ├── 请求ID追踪
  ├── 任务执行链路
  ├── 性能数据记录
  └── 错误堆栈信息
```

## 🚀 部署架构

### 单机部署 (当前)
```
单机服务器:
├── FastAPI应用 (主进程)
├── PostgreSQL 16 (主要数据库)
│   └── SQLite (开发环境可选，URL切换)
├── 文件存储 (本地目录)
└── 日志文件 (本地目录)

优势:
✅ 部署简单
✅ 维护容易
✅ 成本低廉
✅ 适合中小规模
✅ PostgreSQL 16 提供最新性能和特性
✅ 数据库灵活切换，开发生产一致
```

### 扩展部署 (未来)
```
分布式部署:
├── 负载均衡器 (Nginx)
├── 多个API实例
├── PostgreSQL集群
├── Redis缓存
└── 文件存储服务

演进路径:
1. 数据库分离 (PostgreSQL)
2. 缓存分离 (Redis)
3. 文件存储分离 (MinIO/S3)
4. 服务拆分 (微服务)
```

## 🔧 技术栈选择

### 核心技术
```python
# Web框架
FastAPI 0.104+        # 高性能异步Web框架
Uvicorn              # ASGI服务器

# 数据处理
Pydantic 2.0+        # 数据验证和序列化
SQLAlchemy 2.0+      # ORM框架
Alembic              # 数据库迁移

# 异步处理
asyncio              # 异步编程
aiohttp              # 异步HTTP客户端
aiofiles             # 异步文件操作

# AI集成
OpenAI API           # GPT模型
Google Gemini        # Gemini模型
LangChain            # LLM应用框架
```

### 开发工具
```python
# 代码质量
pytest               # 测试框架
black                # 代码格式化
flake8               # 代码检查
mypy                 # 类型检查

# 文档工具
Swagger UI           # API文档
ReDoc                # API文档
MkDocs               # 项目文档
```

## 📋 架构决策记录

### ADR-001: 选择FastAPI而非Django/Flask
**决策**: 使用FastAPI作为Web框架  
**理由**: 
- 原生异步支持，性能优秀
- 自动API文档生成
- 类型安全和数据验证
- 现代化的开发体验

### ADR-002: 使用BackgroundTasks而非Celery
**决策**: 基于FastAPI BackgroundTasks构建异步任务系统  
**理由**:
- 避免额外中间件依赖
- 部署和维护简单
- 当前规模足够使用
- 支持渐进式演进

### ADR-003: 单体架构而非微服务
**决策**: 采用模块化单体架构  
**理由**:
- 开发和部署简单
- 适合团队规模
- 避免分布式复杂性
- 支持未来拆分

## 🎯 架构演进规划

### 短期 (1-3个月)
- [x] 完成API接口层
- [ ] 优化异步任务系统
- [ ] 完善监控和日志
- [ ] 性能测试和优化

### 中期 (3-6个月)
- [ ] 数据库分离 (PostgreSQL)
- [ ] 缓存系统 (Redis)
- [ ] 容器化部署 (Docker)
- [ ] CI/CD流水线

### 长期 (6-12个月)
- [ ] 微服务拆分
- [ ] 服务网格 (Istio)
- [ ] 云原生部署 (Kubernetes)
- [ ] 多租户支持

---

**文档维护**: 本文档随架构演进持续更新  
**最后更新**: 2025-01-15  
**下次评审**: 2025-02-15
