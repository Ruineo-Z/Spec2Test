# Spec2Test 项目结构 - 更新版

**更新时间**: 2025-01-15 20:45
**版本**: v2.0 - LangChain集成版

## 📁 项目目录结构

```
Spec2Test/
├── .dev/                           # 开发文档目录
│   ├── 开发TodoList.md             # 开发任务清单
│   ├── 阶段2.3-数据验证模式-开发结果.md
│   ├── 阶段2.4-数据库迁移-开发结果.md
│   ├── 阶段3.1-共享组件开发-开发结果.md
│   └── 项目结构-更新.md           # 本文件
├── .doc/                           # 项目文档目录
├── .env.example                    # 环境变量示例
├── .gitignore                      # Git忽略文件
├── README.md                       # 项目说明
├── requirements.txt                # Python依赖包
├── pyproject.toml                  # 项目配置
├── alembic.ini                     # 数据库迁移配置
├── alembic/                        # 数据库迁移目录
│   ├── env.py                      # 迁移环境配置
│   └── versions/                   # 迁移版本文件
│       └── 001_initial_tables.py   # 初始表结构迁移
├── app/                            # 应用程序代码
│   ├── __init__.py
│   ├── config.py                   # 配置管理
│   ├── database.py                 # 数据库管理
│   ├── dependencies.py             # 依赖注入
│   ├── models/                     # 数据模型
│   │   ├── __init__.py
│   │   ├── base.py                 # 基础模型类
│   │   ├── document.py             # 文档模型
│   │   ├── test_case.py            # 测试用例模型
│   │   ├── test_result.py          # 测试结果模型
│   │   └── report.py               # 报告模型
│   ├── schemas/                    # API数据验证Schema
│   │   ├── __init__.py
│   │   ├── document.py             # 文档Schema
│   │   ├── test_case.py            # 测试用例Schema
│   │   ├── test_result.py          # 测试结果Schema
│   │   └── report.py               # 报告Schema
│   └── core/                       # 核心业务逻辑
│       └── shared/                 # 共享组件
│           ├── llm/                # LLM抽象层 (LangChain集成)
│           │   ├── __init__.py
│           │   ├── base.py         # LLM基础接口
│           │   ├── factory.py      # LLM工厂类
│           │   ├── langchain_client.py  # LangChain客户端实现
│           │   └── models.py       # 结构化输出模型
│           ├── http/               # HTTP客户端组件
│           │   ├── __init__.py
│           │   ├── client.py       # HTTP客户端
│           │   ├── auth.py         # 认证处理器
│           │   └── performance.py  # 性能监控器
│           └── utils/              # 工具类
│               ├── __init__.py
│               └── logger.py       # 日志工具
├── tests/                          # 测试代码
│   ├── __init__.py
│   ├── test_models.py              # 模型测试
│   └── test_schemas.py             # Schema测试
└── scripts/                        # 脚本文件
    ├── test_migration.py           # 数据库迁移测试
    ├── test_database_connection.py # 数据库连接测试
    ├── create_migration.py         # 迁移文件生成
    └── test_llm_integration.py     # LLM集成测试
```

## 🔧 核心组件架构

### 1. LLM抽象层 (基于LangChain + Instructor)
```
app/core/shared/llm/
├── base.py                 # 抽象基类和数据结构
├── factory.py              # 工厂类和客户端管理
├── langchain_client.py     # LangChain集成实现
└── models.py               # 结构化输出Pydantic模型
```

**支持的LLM提供商**:
- ✅ **Ollama** (本地LLM服务)
- ✅ **OpenAI** (GPT系列模型)
- ❌ ~~Gemini~~ (已移除，暂不支持LangChain集成)

**核心特性**:
- 🎯 **结构化输出**: 使用Pydantic模型确保类型安全
- 🔄 **统一接口**: 所有提供商使用相同的抽象接口
- 🏭 **工厂模式**: 统一的客户端创建和管理
- 📊 **丰富模型**: APITestCase、TestSuite、DocumentAnalysis等

### 2. HTTP客户端组件
```
app/core/shared/http/
├── client.py               # 功能完整的HTTP客户端
├── auth.py                 # 多种认证方式支持
└── performance.py          # 性能监控和统计
```

**核心特性**:
- 🌐 **统一HTTP接口**: 支持所有HTTP方法
- 🔐 **多种认证**: Bearer、Basic、API Key等
- 📈 **性能监控**: 响应时间、成功率、百分位数统计
- 🔄 **智能重试**: 自动重试机制和错误恢复

### 3. 数据模型层
```
app/models/
├── base.py                 # 基础模型类 (SQLAlchemy)
├── document.py             # 文档模型
├── test_case.py            # 测试用例模型
├── test_result.py          # 测试结果模型
└── report.py               # 报告模型
```

**核心特性**:
- 🗄️ **完整数据模型**: 4个核心业务表
- 🔗 **关系映射**: 外键约束和级联操作
- 📝 **审计字段**: 创建时间、更新时间、软删除
- 🏷️ **枚举支持**: 类型安全的枚举字段

### 4. API数据验证层
```
app/schemas/
├── document.py             # 文档API Schema
├── test_case.py            # 测试用例API Schema
├── test_result.py          # 测试结果API Schema
└── report.py               # 报告API Schema
```

**核心特性**:
- ✅ **数据验证**: Pydantic自动验证
- 📋 **CRUD支持**: 创建、更新、响应、详情Schema
- 🔍 **筛选排序**: 灵活的查询参数验证
- 📊 **统计分析**: 统计和分析数据Schema

## 🚀 技术栈

### 核心框架
- **FastAPI**: Web框架
- **SQLAlchemy**: ORM框架
- **Alembic**: 数据库迁移
- **Pydantic**: 数据验证

### LLM集成
- **LangChain**: LLM统一接口
- **Instructor**: 结构化输出
- **OpenAI**: GPT模型支持
- **Ollama**: 本地LLM支持

### 数据库
- **PostgreSQL**: 生产数据库
- **SQLite**: 开发测试数据库

### 工具库
- **Requests**: HTTP客户端
- **Celery**: 异步任务
- **Redis**: 缓存和消息队列

## 📊 代码统计

| 组件 | 文件数 | 代码行数 | 主要功能 |
|------|--------|----------|----------|
| LLM抽象层 | 4 | 800+ | LangChain集成、结构化输出 |
| HTTP组件 | 3 | 765 | HTTP客户端、认证、性能监控 |
| 数据模型 | 5 | 600+ | SQLAlchemy模型定义 |
| API Schema | 4 | 1000+ | Pydantic数据验证 |
| 数据库迁移 | 1 | 200+ | 表结构和索引 |
| 测试脚本 | 4 | 500+ | 功能验证和测试 |
| **总计** | **21** | **3865+** | **完整的API测试平台** |

## 🔄 版本变更

### v2.0 (当前版本) - LangChain集成
- ✅ **LLM抽象层重构**: 完全迁移到LangChain + Instructor
- ✅ **结构化输出支持**: Pydantic模型确保类型安全
- ✅ **废弃代码清理**: 删除旧版Gemini和Ollama实现
- ✅ **依赖优化**: 移除不需要的依赖包
- ✅ **提供商精简**: 专注于Ollama和OpenAI支持

### v1.0 - 基础版本
- ✅ 数据模型层完成
- ✅ API Schema完成
- ✅ 数据库迁移完成
- ✅ 共享组件基础版本

## 🎯 下一步开发计划

### 阶段3.2 - 存储抽象层
- 文件存储抽象层
- 数据库存储抽象层
- 缓存存储抽象层

### 阶段4 - 核心业务模块
- 文档解析器
- 测试用例生成器
- 测试执行器
- 报告生成器

### 阶段5 - API接口层
- FastAPI路由定义
- 中间件和异常处理
- API文档生成

## 🛠️ 开发工具

### 代码质量
- **Black**: 代码格式化
- **isort**: 导入排序
- **Flake8**: 代码检查

### 测试工具
- **Pytest**: 单元测试框架
- **自定义脚本**: 集成测试和验证

### 开发环境
- **Python 3.11+**: 运行环境
- **Poetry/pip**: 依赖管理
- **Git**: 版本控制

---

**项目结构已更新为LangChain集成版本，废弃代码已清理完毕。** 🎉
